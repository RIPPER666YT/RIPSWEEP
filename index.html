<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Кооперативный Сапёр</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        #game-container {
            display: inline-block;
            margin-top: 20px;
            background-color: #bbb;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        #board {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            grid-gap: 2px;
            margin: 0 auto;
        }
        .cell {
            width: 30px;
            height: 30px;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            user-select: none;
            position: relative;
        }
        .cell.revealed {
            background-color: #eee;
        }
        .cell.mine {
            background-color: #ff9999;
        }
        .cell.flagged {
            background-color: #99ccff;
        }
        #controls {
            margin: 20px 0;
        }
        #status {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            min-height: 24px;
        }
        #player-list {
            margin: 20px auto;
            max-width: 300px;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .color-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
        #nickname-container {
            margin: 20px auto;
            max-width: 300px;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        #game-id-display {
            font-family: monospace;
            font-size: 18px;
            margin: 15px 0;
            padding: 8px;
            background-color: #f8f8f8;
            border-radius: 4px;
            word-break: break-all;
        }
        #game-info {
            margin: 20px auto;
            max-width: 300px;
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .player-turn {
            font-weight: bold;
            color: #2E7D32;
        }
    </style>
</head>
<body>
    <h1>Кооперативный Сапёр</h1>
    
    <div id="nickname-container">
        <h3>Введите ваш ник</h3>
        <input type="text" id="nickname" placeholder="Ваш ник" maxlength="20">
        <button id="set-nickname">Продолжить</button>
        <div id="nickname-status"></div>
        
        <div id="game-actions" style="display: none; margin-top: 20px;">
            <button id="create-game-btn">Создать игру</button>
            <div style="margin: 10px 0;">или</div>
            <input type="text" id="game-id-input" placeholder="Введите ID игры">
            <button id="join-game-btn">Присоединиться</button>
        </div>
    </div>
    
    <div id="game-area" style="display: none;">
        <div id="game-info">
            <div>ID игры: <span id="game-id-display"></span></div>
            <div id="status">Ожидание начала игры...</div>
        </div>
        
        <div id="controls">
            <button id="new-game-btn" disabled>Новая игра</button>
        </div>
        
        <div id="game-container">
            <div id="board"></div>
        </div>
        
        <div id="player-list">
            <h3>Игроки:</h3>
            <ul id="players"></ul>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_NY3eXimeD74iU6g8qZE0wsl7yexWThw",
            authDomain: "ripsweep-1aaaf.firebaseapp.com",
            databaseURL: "https://ripsweep-1aaaf-default-rtdb.firebaseio.com",
            projectId: "ripsweep-1aaaf",
            storageBucket: "ripsweep-1aaaf.appspot.com",
            messagingSenderId: "600546881732",
            appId: "1:600546881732:web:e3e8f2c2980c583e3e5991",
            measurementId: "G-HS9JT49X7R"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Конфигурация игры
        const config = {
            rows: 10,
            cols: 10,
            mines: 15,
            cellSize: 30
        };
        
        // Состояние игры
        let gameState = {
            board: [],
            revealed: [],
            flagged: [],
            gameOver: false,
            gameWon: false,
            players: {},
            currentPlayerId: null,
            gameId: null,
            creatorId: null
        };
        
        // Текущий игрок
        let currentPlayer = {
            id: null,
            name: null,
            color: null
        };
        
        // Элементы DOM
        const nicknameContainer = document.getElementById('nickname-container');
        const gameArea = document.getElementById('game-area');
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const newGameBtn = document.getElementById('new-game-btn');
        const playersList = document.getElementById('players');
        const nicknameInput = document.getElementById('nickname');
        const setNicknameBtn = document.getElementById('set-nickname');
        const nicknameStatus = document.getElementById('nickname-status');
        const gameActions = document.getElementById('game-actions');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const gameIdDisplay = document.getElementById('game-id-display');
        const gameInfo = document.getElementById('game-info');
        
        // Цвета для игроков
        const playerColors = [
            '#FF5252', '#FF4081', '#E040FB', '#7C4DFF', 
            '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', 
            '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', 
            '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'
        ];
        
        // Инициализация игры
        function initGame() {
            // Очистка доски
            boardElement.innerHTML = '';
            boardElement.style.gridTemplateColumns = `repeat(${config.cols}, ${config.cellSize}px)`;
            
            // Инициализация состояния
            gameState.board = Array(config.rows).fill().map(() => Array(config.cols).fill(0));
            gameState.revealed = Array(config.rows).fill().map(() => Array(config.cols).fill(false));
            gameState.flagged = Array(config.rows).fill().map(() => Array(config.cols).fill(false));
            gameState.gameOver = false;
            gameState.gameWon = false;
            
            // Создание доски
            for (let row = 0; row < config.rows; row++) {
                for (let col = 0; col < config.cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleCellRightClick(row, col);
                    });
                    
                    boardElement.appendChild(cell);
                }
            }
            
            statusElement.textContent = 'Ожидание первого хода...';
        }
        
        // Генерация мин
        function generateMines(firstClickRow, firstClickCol) {
            let minesPlaced = 0;
            
            while (minesPlaced < config.mines) {
                const row = Math.floor(Math.random() * config.rows);
                const col = Math.floor(Math.random() * config.cols);
                
                // Не ставим мину на первую нажатую клетку и вокруг неё
                if ((row === firstClickRow && col === firstClickCol) || 
                    (Math.abs(row - firstClickRow) <= 1 && Math.abs(col - firstClickCol) <= 1)) {
                    continue;
                }
                
                if (gameState.board[row][col] !== -1) {
                    gameState.board[row][col] = -1;
                    minesPlaced++;
                    
                    // Обновляем счетчики соседей
                    for (let r = Math.max(0, row - 1); r <= Math.min(config.rows - 1, row + 1); r++) {
                        for (let c = Math.max(0, col - 1); c <= Math.min(config.cols - 1, col + 1); c++) {
                            if (gameState.board[r][c] !== -1) {
                                gameState.board[r][c]++;
                            }
                        }
                    }
                }
            }
        }
        
        // Обработка клика по клетке
        function handleCellClick(row, col) {
            if (gameState.gameOver || gameState.gameWon || gameState.currentPlayerId !== currentPlayer.id) {
                return;
            }
            
            // Если это первый ход, генерируем мины
            if (gameState.board.flat().every(cell => cell === 0)) {
                generateMines(row, col);
                updateGameState();
            }
            
            if (gameState.flagged[row][col]) {
                return;
            }
            
            if (gameState.board[row][col] === -1) {
                // Наступили на мину
                revealAllMines();
                gameState.gameOver = true;
                statusElement.textContent = 'Игра окончена! Вы проиграли.';
                updateGameState();
            } else {
                // Раскрываем клетку
                revealCell(row, col);
                if (checkWinCondition()) {
                    gameState.gameWon = true;
                    statusElement.textContent = 'Поздравляем! Вы победили!';
                }
                updateGameState();
                switchPlayer();
            }
        }
        
        // Обработка правого клика по клетке (флаг)
        function handleCellRightClick(row, col) {
            if (gameState.gameOver || gameState.gameWon || gameState.currentPlayerId !== currentPlayer.id) {
                return;
            }
            
            if (!gameState.revealed[row][col]) {
                gameState.flagged[row][col] = !gameState.flagged[row][col];
                updateCellUI(row, col);
                updateGameState();
            }
        }
        
        // Раскрытие клетки
        function revealCell(row, col) {
            if (row < 0 || row >= config.rows || col < 0 || col >= config.cols || 
                gameState.revealed[row][col] || gameState.flagged[row][col]) {
                return;
            }
            
            gameState.revealed[row][col] = true;
            updateCellUI(row, col);
            
            // Если клетка пустая, раскрываем соседей
            if (gameState.board[row][col] === 0) {
                for (let r = row - 1; r <= row + 1; r++) {
                    for (let c = col - 1; c <= col + 1; c++) {
                        if (r !== row || c !== col) {
                            revealCell(r, c);
                        }
                    }
                }
            }
        }
        
        // Раскрытие всех мин (при проигрыше)
        function revealAllMines() {
            for (let row = 0; row < config.rows; row++) {
                for (let col = 0; col < config.cols; col++) {
                    if (gameState.board[row][col] === -1) {
                        gameState.revealed[row][col] = true;
                        updateCellUI(row, col);
                    }
                }
            }
        }
        
        // Проверка условия победы
        function checkWinCondition() {
            let allNonMinesRevealed = true;
            
            for (let row = 0; row < config.rows; row++) {
                for (let col = 0; col < config.cols; col++) {
                    if (gameState.board[row][col] !== -1 && !gameState.revealed[row][col]) {
                        allNonMinesRevealed = false;
                        break;
                    }
                }
                if (!allNonMinesRevealed) break;
            }
            
            return allNonMinesRevealed;
        }
        
        // Обновление отображения клетки
        function updateCellUI(row, col) {
            const cellIndex = row * config.cols + col;
            const cellElement = boardElement.children[cellIndex];
            
            cellElement.className = 'cell';
            
            if (gameState.revealed[row][col]) {
                cellElement.classList.add('revealed');
                
                if (gameState.board[row][col] === -1) {
                    cellElement.classList.add('mine');
                    cellElement.innerHTML = createMineSVG();
                } else if (gameState.board[row][col] > 0) {
                    cellElement.textContent = gameState.board[row][col];
                    cellElement.style.color = getNumberColor(gameState.board[row][col]);
                }
            } else if (gameState.flagged[row][col]) {
                cellElement.classList.add('flagged');
                cellElement.innerHTML = createFlagSVG();
            }
        }
        
        // Создание SVG изображения мины
        function createMineSVG() {
            return `
                <svg viewBox="0 0 30 30" width="20" height="20">
                    <circle cx="15" cy="15" r="10" fill="black"/>
                    <circle cx="15" cy="15" r="6" fill="red"/>
                    <line x1="5" y1="5" x2="10" y2="10" stroke="black" stroke-width="2"/>
                    <line x1="20" y1="5" x2="25" y2="10" stroke="black" stroke-width="2"/>
                    <line x1="5" y1="25" x2="10" y2="20" stroke="black" stroke-width="2"/>
                    <line x1="25" y1="25" x2="20" y2="20" stroke="black" stroke-width="2"/>
                </svg>
            `;
        }
        
        // Создание SVG изображения флага
        function createFlagSVG() {
            return `
                <svg viewBox="0 0 30 30" width="20" height="20">
                    <rect x="10" y="5" width="2" height="20" fill="black"/>
                    <polygon points="12,5 12,15 22,10" fill="red"/>
                </svg>
            `;
        }
        
        // Получение цвета для числа
        function getNumberColor(number) {
            const colors = [
                '',       // 0 - не отображается
                '#1976D2', // 1 - синий
                '#388E3C', // 2 - зеленый
                '#D32F2F', // 3 - красный
                '#7B1FA2', // 4 - фиолетовый
                '#FF8F00', // 5 - оранжевый
                '#0097A7', // 6 - бирюзовый
                '#000000', // 7 - черный
                '#616161'  // 8 - серый
            ];
            return colors[number];
        }
        
        // Обновление списка игроков
        function updatePlayersList() {
            playersList.innerHTML = '';
            
            for (const [id, player] of Object.entries(gameState.players)) {
                const li = document.createElement('li');
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                colorIndicator.style.backgroundColor = player.color;
                
                li.appendChild(colorIndicator);
                
                const playerNameSpan = document.createElement('span');
                playerNameSpan.textContent = player.name;
                if (id === gameState.currentPlayerId) {
                    playerNameSpan.classList.add('player-turn');
                }
                
                li.appendChild(playerNameSpan);
                
                if (id === currentPlayer.id) {
                    li.innerHTML += ' (Вы)';
                }
                
                if (id === gameState.creatorId) {
                    li.innerHTML += ' (Создатель)';
                }
                
                playersList.appendChild(li);
            }
        }
        
        // Смена текущего игрока
        function switchPlayer() {
            const playerIds = Object.keys(gameState.players);
            if (playerIds.length === 0) return;
            
            const currentIndex = playerIds.indexOf(gameState.currentPlayerId);
            const nextIndex = (currentIndex + 1) % playerIds.length;
            gameState.currentPlayerId = playerIds[nextIndex];
            
            updatePlayersList();
            updateStatus();
            updateGameState();
        }
        
        // Обновление статуса игры
        function updateStatus() {
            if (gameState.gameOver) {
                statusElement.textContent = 'Игра окончена! Вы проиграли.';
            } else if (gameState.gameWon) {
                statusElement.textContent = 'Поздравляем! Вы победили!';
            } else {
                if (gameState.currentPlayerId === currentPlayer.id) {
                    statusElement.textContent = 'Ваш ход!';
                } else {
                    statusElement.textContent = `Ход игрока ${gameState.players[gameState.currentPlayerId].name}`;
                }
            }
        }
        
        // Обновление состояния игры в Firebase
        function updateGameState() {
            if (!gameState.gameId) return;
            
            database.ref(`games/${gameState.gameId}`).set({
                board: gameState.board,
                revealed: gameState.revealed,
                flagged: gameState.flagged,
                gameOver: gameState.gameOver,
                gameWon: gameState.gameWon,
                players: gameState.players,
                currentPlayerId: gameState.currentPlayerId,
                creatorId: gameState.creatorId
            });
        }
        
        // Создание новой игры
        function createNewGame() {
            gameState.gameId = 'game_' + Date.now();
            currentPlayer.id = 'player_' + Date.now();
            currentPlayer.color = playerColors[0];
            gameState.creatorId = currentPlayer.id;
            
            gameState.players = {
                [currentPlayer.id]: {
                    name: currentPlayer.name,
                    color: currentPlayer.color
                }
            };
            gameState.currentPlayerId = currentPlayer.id;
            
            // Показываем ID игры
            gameIdDisplay.textContent = gameState.gameId;
            
            // Разрешаем создателю начинать новую игру
            newGameBtn.disabled = false;
            
            // Создаем игру в Firebase
            updateGameState();
            
            // Инициализируем игру
            initGame();
            gameArea.style.display = 'block';
            nicknameContainer.style.display = 'none';
            updateStatus();
            updatePlayersList();
            
            // Слушаем изменения в игре
            database.ref(`games/${gameState.gameId}`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    gameState.board = data.board || gameState.board;
                    gameState.revealed = data.revealed || gameState.revealed;
                    gameState.flagged = data.flagged || gameState.flagged;
                    gameState.gameOver = data.gameOver || false;
                    gameState.gameWon = data.gameWon || false;
                    gameState.players = data.players || gameState.players;
                    gameState.currentPlayerId = data.currentPlayerId || gameState.currentPlayerId;
                    gameState.creatorId = data.creatorId || gameState.creatorId;
                    
                    // Обновляем UI
                    updateBoardUI();
                    updatePlayersList();
                    updateStatus();
                }
            });
        }
        
        // Присоединение к существующей игре
        function joinGame(gameId) {
            gameState.gameId = gameId;
            currentPlayer.id = 'player_' + Date.now();
            
            // Получаем данные игры
            database.ref(`games/${gameId}`).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    nicknameStatus.textContent = 'Игра не найдена!';
                    nicknameStatus.style.color = 'red';
                    return;
                }
                
                // Обновляем состояние
                gameState.board = data.board || gameState.board;
                gameState.revealed = data.revealed || gameState.revealed;
                gameState.flagged = data.flagged || gameState.flagged;
                gameState.gameOver = data.gameOver || false;
                gameState.gameWon = data.gameWon || false;
                gameState.players = data.players || {};
                gameState.currentPlayerId = data.currentPlayerId || null;
                gameState.creatorId = data.creatorId || null;
                
                // Выбираем цвет для нового игрока
                const playerCount = Object.keys(gameState.players).length;
                currentPlayer.color = playerColors[playerCount % playerColors.length];
                
                // Добавляем текущего игрока в игру
                gameState.players[currentPlayer.id] = {
                    name: currentPlayer.name,
                    color: currentPlayer.color
                };
                
                // Показываем ID игры
                gameIdDisplay.textContent = gameState.gameId;
                
                // Запрещаем присоединившемуся начинать новую игру
                newGameBtn.disabled = true;
                
                // Обновляем игру в Firebase
                updateGameState();
                
                // Инициализируем игру
                initGame();
                gameArea.style.display = 'block';
                nicknameContainer.style.display = 'none';
                updateBoardUI();
                updatePlayersList();
                updateStatus();
                
                // Слушаем изменения в игре
                database.ref(`games/${gameId}`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        gameState.board = data.board || gameState.board;
                        gameState.revealed = data.revealed || gameState.revealed;
                        gameState.flagged = data.flagged || gameState.flagged;
                        gameState.gameOver = data.gameOver || false;
                        gameState.gameWon = data.gameWon || false;
                        gameState.players = data.players || gameState.players;
                        gameState.currentPlayerId = data.currentPlayerId || gameState.currentPlayerId;
                        gameState.creatorId = data.creatorId || gameState.creatorId;
                        
                        // Обновляем UI
                        updateBoardUI();
                        updatePlayersList();
                        updateStatus();
                    }
                });
            });
        }
        
        // Обновление всей доски
        function updateBoardUI() {
            for (let row = 0; row < config.rows; row++) {
                for (let col = 0; col < config.cols; col++) {
                    updateCellUI(row, col);
                }
            }
        }
        
        // Обработчики кнопок
        setNicknameBtn.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (nickname.length < 2) {
                nicknameStatus.textContent = 'Ник должен быть не короче 2 символов';
                nicknameStatus.style.color = 'red';
                return;
            }
            
            currentPlayer.name = nickname;
            nicknameStatus.textContent = '';
            gameActions.style.display = 'block';
        });
        
        createGameBtn.addEventListener('click', () => {
            createNewGame();
        });
        
        joinGameBtn.addEventListener('click', () => {
            const gameId = gameIdInput.value.trim();
            if (gameId) {
                joinGame(gameId);
            } else {
                nicknameStatus.textContent = 'Введите ID игры!';
                nicknameStatus.style.color = 'red';
            }
        });
        
        newGameBtn.addEventListener('click', () => {
            if (!gameState.gameId || currentPlayer.id !== gameState.creatorId) return;
            
            // Сброс состояния игры
            gameState.board = Array(config.rows).fill().map(() => Array(config.cols).fill(0));
            gameState.revealed = Array(config.rows).fill().map(() => Array(config.cols).fill(false));
            gameState.flagged = Array(config.rows).fill().map(() => Array(config.cols).fill(false));
            gameState.gameOver = false;
            gameState.gameWon = false;
            
            // Первый ход - создатель игры
            gameState.currentPlayerId = gameState.creatorId;
            
            updateGameState();
            initGame();
            updateStatus();
        });
    </script>
</body>
</html>
